<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ライブ情報管理（修正・削除機能付き）</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; line-height: 1.6; background: #f4f7f6; }
        .box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #2c3e50; padding-bottom: 10px; color: #2c3e50; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #2c3e50; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; }
        button:hover { background: #34495e; }
        .delete-btn { background: #e74c3c; width: auto; padding: 5px 10px; font-size: 12px; margin-top: 0; }
        .delete-btn:hover { background: #c0392b; }
        .live-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .edit-link { color: #3498db; cursor: pointer; text-decoration: underline; }
        #status { margin-top: 20px; padding: 10px; border-radius: 4px; display: none; }
    </style>
</head>
<body>

    <h1>ライブ情報管理</h1>

    <div class="box">
        <h2>1. 認証設定</h2>
        <label>GitHubトークン (ghp_...)</label>
        <input type="password" id="token" placeholder="一度入力すると保存されます">
    </div>

    <div class="box">
        <h2 id="form-title">2. ライブ情報の新規登録 / 修正</h2>
        <input type="hidden" id="edit-sha"> <label>日付 (例: 2026-01-06)</label>
        <input type="date" id="date">

        <label>ライブタイトル</label>
        <input type="text" id="title" placeholder="イベント名">

        <label>会場</label>
        <input type="text" id="place" placeholder="ライブハウス名">

        <label>チケットURL (任意)</label>
        <input type="url" id="ticketUrl" placeholder="https://...">

        <button onclick="saveLive()">GitHubへ保存（新規・上書き）</button>
        <button onclick="resetForm()" style="background:#95a5a6; margin-top:10px;">入力をクリア（新規登録に戻る）</button>
    </div>

    <div class="box">
        <h2>3. 登録済みライブ一覧（修正・削除）</h2>
        <div id="live-list">読み込み中...</div>
    </div>

    <div id="status"></div>

    <script>
        const REPO = "shinoefuhi/shinoefuhi-site"; // あなたのリポジトリ
        const tokenInput = document.getElementById('token');

        // ページ読み込み時にトークンを復元し、一覧を表示
        window.onload = () => {
            const savedToken = localStorage.getItem('gh_token');
            if (savedToken) tokenInput.value = savedToken;
            loadLiveList();
        };

        // 一覧を読み込む
        async function loadLiveList() {
            const listDiv = document.getElementById('live-list');
            const token = tokenInput.value;
            if (!token) {
                listDiv.innerHTML = "トークンを入力すると一覧が表示されます。";
                return;
            }

            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}/contents/_data/lives`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (!res.ok) throw new Error();
                const files = await res.json();

                listDiv.innerHTML = "";
                files.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'live-item';
                    item.innerHTML = `
                        <span>${file.name}</span>
                        <div>
                            <span class="edit-link" onclick="prepareEdit('${file.path}', '${file.sha}')">修正</span> | 
                            <button class="delete-btn" onclick="deleteLive('${file.path}', '${file.sha}')">削除</button>
                        </div>
                    `;
                    listDiv.appendChild(item);
                });
            } catch (e) {
                listDiv.innerHTML = "データの取得に失敗しました。トークンやリポジトリ名を確認してください。";
            }
        }

        // 修正の準備
        async function prepareEdit(path, sha) {
            const token = tokenInput.value;
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            const data = await res.json();
            const content = decodeURIComponent(escape(atob(data.content)));
            
            // 簡易的な解析（YAMLを自前でパース）
            const lines = content.split('\n');
            const info = {};
            lines.forEach(line => {
                const [key, ...val] = line.split(':');
                if (key) info[key.trim()] = val.join(':').trim();
            });

            document.getElementById('date').value = info.date || "";
            document.getElementById('title').value = info.title || "";
            document.getElementById('place').value = info.place || "";
            document.getElementById('ticketUrl').value = info.ticketUrl || "";
            document.getElementById('edit-sha').value = sha;
            document.getElementById('form-title').innerText = "2. ライブ情報の修正（上書きモード）";
            window.scrollTo(0, 0);
        }

        // 保存（新規・上書き）
        async function saveLive() {
            const token = tokenInput.value;
            const date = document.getElementById('date').value;
            const title = document.getElementById('title').value;
            const place = document.getElementById('place').value;
            const ticketUrl = document.getElementById('ticketUrl').value;
            const sha = document.getElementById('edit-sha').value;

            if (!token || !date || !title) {
                alert("トークン、日付、タイトルは必須です。");
                return;
            }

            localStorage.setItem('gh_token', token);

            const fileName = `${date}-${title.replace(/\s+/g, '-')}.yml`;
            const path = `_data/lives/${fileName}`;
            const yamlContent = `date: ${date}\ntitle: ${title}\nplace: ${place}\nticketUrl: ${ticketUrl}`;
            const base64Content = btoa(unescape(encodeURIComponent(yamlContent)));

            const body = {
                message: `Update live: ${fileName}`,
                content: base64Content
            };
            if (sha) body.sha = sha; // 修正時はshaを付与

            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                showStatus("保存に成功しました！反映まで数分お待ちください。", "green");
                resetForm();
                loadLiveList();
            } else {
                showStatus("エラーが発生しました。", "red");
            }
        }

        // 削除
        async function deleteLive(path, sha) {
            if (!confirm("本当にこのライブ情報を削除しますか？")) return;
            const token = tokenInput.value;

            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Delete live", sha: sha })
            });

            if (res.ok) {
                showStatus("削除しました。", "orange");
                loadLiveList();
            }
        }

        function resetForm() {
            document.getElementById('date').value = "";
            document.getElementById('title').value = "";
            document.getElementById('place').value = "";
            document.getElementById('ticketUrl').value = "";
            document.getElementById('edit-sha').value = "";
            document.getElementById('form-title').innerText = "2. ライブ情報の新規登録 / 修正";
        }

        function showStatus(msg, color) {
            const s = document.getElementById('status');
            s.innerText = msg;
            s.style.display = "block";
            s.style.backgroundColor = color === "green" ? "#dff0d8" : "#f2dede";
            setTimeout(() => s.style.display = "none", 5000);
        }
    </script>
</body>
</html>
