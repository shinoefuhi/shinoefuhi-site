<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>shinoefuhi 統合管理画面</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #f4f7f6; color: #2c3e50; }
        .box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        h2 { border-left: 5px solid #2c3e50; padding-left: 15px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: #2c3e50; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; font-weight: bold; }
        button:hover { background: #34495e; }
        .delete-btn { background: #e74c3c; width: auto; padding: 5px 12px; font-size: 12px; margin-top: 0; }
        .live-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .edit-link { color: #3498db; cursor: pointer; text-decoration: underline; font-size: 0.9em; }
        #status { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; display: none; z-index: 1000; }
        .type-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 8px; }
    </style>
</head>
<body>

    <h1>shinoefuhi 統合管理システム</h1>

    <div class="box">
        <h2>1. 認証</h2>
        <input type="password" id="token" placeholder="GitHubトークン (ghp_...)">
    </div>

    <div class="box">
        <h2 id="live-form-title">2. ライブ情報の登録/修正</h2>
        <input type="hidden" id="live-sha">
        <div class="grid">
            <div><label>日付</label><input type="date" id="live-date"></div>
            <div><label>タイトル</label><input type="text" id="live-title"></div>
        </div>
        <div class="grid">
            <div><label>会場</label><input type="text" id="live-place"></div>
            <div><label>料金 (例: ¥3,000 +1D)</label><input type="text" id="live-price"></div>
        </div>
        <div class="grid">
            <div><label>OPEN時間</label><input type="time" id="live-open"></div>
            <div><label>START時間</label><input type="time" id="live-start"></div>
        </div>
        <div class="grid">
            <div><label>チケットURL</label><input type="url" id="live-ticket" placeholder="https://..."></div>
            <div><label>Twitter/X 告知URL</label><input type="url" id="live-twitter" placeholder="https://x.com/..."></div>
        </div>
        <label>フライヤー画像URL (GitHubに上げた写真のURL)</label>
        <input type="text" id="live-flyer" placeholder="https://raw.githubusercontent.com/...">
        <button onclick="saveItem('live')">ライブ情報を保存</button>
        <button onclick="resetForm('live')" style="background:#95a5a6; margin-top:10px;">入力をクリア</button>
    </div>

    <div class="box">
        <h2 id="disc-form-title">3. Discographyの登録/修正</h2>
        <input type="hidden" id="disc-sha">
        <label>作品タイトル</label><input type="text" id="disc-title">
        <label>画像URL (GitHubに上げた写真のURL)</label><input type="text" id="disc-image">
        <div class="grid">
            <div><label>YouTube URL</label><input type="url" id="disc-youtube"></div>
            <div><label>Spotify URL</label><input type="url" id="disc-spotify"></div>
        </div>
        <button onclick="saveItem('disc')" style="background:#27ae60;">作品情報を保存</button>
        <button onclick="resetForm('disc')" style="background:#95a5a6; margin-top:10px;">入力をクリア</button>
    </div>

    <div class="box">
        <h2>4. 登録済みデータ一覧</h2>
        <div id="data-list">読み込み中...</div>
    </div>

    <div id="status"></div>

    <script>
        const REPO = "shinoefuhi/shinoefuhi-site";
        const tokenInput = document.getElementById('token');

        window.onload = () => {
            const savedToken = localStorage.getItem('gh_token');
            if (savedToken) { tokenInput.value = savedToken; loadAllList(); }
        };

        async function loadAllList() {
            const listDiv = document.getElementById('data-list');
            const token = tokenInput.value;
            if (!token) { listDiv.innerHTML = "トークンを入力してください。"; return; }

            try {
                const liveRes = await fetch(`https://api.github.com/repos/${REPO}/contents/_data/lives`, { headers: { 'Authorization': `token ${token}` } });
                const discRes = await fetch(`https://api.github.com/repos/${REPO}/contents/_data/discography`, { headers: { 'Authorization': `token ${token}` } });
                
                let html = "";
                if(liveRes.ok) {
                    const lives = await liveRes.json();
                    lives.forEach(f => html += createListItem(f, 'live', '#3498db'));
                }
                if(discRes.ok) {
                    const discs = await discRes.json();
                    discs.forEach(f => html += createListItem(f, 'disc', '#27ae60'));
                }
                listDiv.innerHTML = html || "データがありません。";
            } catch (e) { listDiv.innerHTML = "取得エラー"; }
        }

        function createListItem(f, type, color) {
            const typeName = type === 'live' ? 'LIVE' : 'DISC';
            return `<div class="live-item">
                <span><span class="type-badge" style="background:${color}">${typeName}</span> ${f.name}</span>
                <div>
                    <span class="edit-link" onclick="prepareEdit('${f.path}', '${f.sha}', '${type}')">修正</span> | 
                    <button class="delete-btn" onclick="deleteItem('${f.path}', '${f.sha}')">削除</button>
                </div>
            </div>`;
        }

        async function prepareEdit(path, sha, type) {
            const token = tokenInput.value;
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, { headers: { 'Authorization': `token ${token}` } });
            const data = await res.json();
            const content = decodeURIComponent(escape(atob(data.content)));
            const info = {};
            content.split('\n').forEach(line => {
                const [k, ...v] = line.split(':');
                if (k) info[k.trim()] = v.join(':').trim();
            });

            if (type === 'live') {
                document.getElementById('live-date').value = info.date;
                document.getElementById('live-title').value = info.title;
                document.getElementById('live-place').value = info.place;
                document.getElementById('live-price').value = info.price || "";
                document.getElementById('live-open').value = info.open_time || "";
                document.getElementById('live-start').value = info.start_time || "";
                document.getElementById('live-ticket').value = info.ticketUrl || "";
                document.getElementById('live-twitter').value = info.twitterUrl || "";
                document.getElementById('live-flyer').value = info.flyer || "";
                document.getElementById('live-sha').value = sha;
                document.getElementById('live-form-title').innerText = "修正モード中";
            } else {
                document.getElementById('disc-title').value = info.title;
                document.getElementById('disc-image').value = info.image;
                document.getElementById('disc-youtube').value = info.youtube || "";
                document.getElementById('disc-spotify').value = info.spotify || "";
                document.getElementById('live-flyer').value = info.flyer || "";
                document.getElementById('disc-sha').value = sha;
                document.getElementById('disc-form-title').innerText = "修正モード中";
            }
            window.scrollTo(0,0);
        }

        async function saveItem(type) {
            const token = tokenInput.value;
            localStorage.setItem('gh_token', token);
            let path, yaml, sha, fileName;

            if (type === 'live') {
                const d = document.getElementById('live-date').value;
                const t = document.getElementById('live-title').value;
                fileName = `${d}-${t.replace(/\s+/g, '-')}.yml`;
                path = `_data/lives/${fileName}`;
                sha = document.getElementById('live-sha').value;
                yaml = `date: ${d}\ntitle: ${t}
                \nplace: ${document.getElementById('live-place').value}
                \nprice: ${document.getElementById('live-price').value}
                \nopen_time: ${document.getElementById('live-open').value}
                \nstart_time: ${document.getElementById('live-start').value}
                \nticketUrl: ${document.getElementById('live-ticket').value}
                \ntwitterUrl: ${document.getElementById('live-twitter').value}
                \nflyer: ${document.getElementById('live-flyer').value}`;
            } else {
                const t = document.getElementById('disc-title').value;
                fileName = `${t.replace(/\s+/g, '-')}.yml`;
                path = `_data/discography/${fileName}`;
                sha = document.getElementById('disc-sha').value;
                yaml = `title: ${t}\nimage: ${document.getElementById('disc-image').value}\nyoutube: ${document.getElementById('disc-youtube').value}\nspotify: ${document.getElementById('disc-spotify').value}`;
            }

            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: `Update ${type}`, content: btoa(unescape(encodeURIComponent(yaml))), sha: sha || undefined })
            });

            if (res.ok) { alert("保存しました！"); resetForm(type); loadAllList(); }
        }

        async function deleteItem(path, sha) {
            if (!confirm("消去しますか？")) return;
            await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${tokenInput.value}` },
                body: JSON.stringify({ message: "Delete", sha: sha })
            });
            loadAllList();
        }

        function resetForm(type) {
            if(type==='live'){
                document.querySelectorAll('.box:nth-of-type(2) input').forEach(i => i.value="");
                document.getElementById('live-form-title').innerText = "2. ライブ情報の登録/修正";
            } else {
                document.querySelectorAll('.box:nth-of-type(3) input').forEach(i => i.value="");
                document.getElementById('disc-form-title').innerText = "3. Discographyの登録/修正";
            }
        }
    </script>
</body>
</html>
