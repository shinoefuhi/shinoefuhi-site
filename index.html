<script>
    const REPO = "shinoefuhi/shinoefuhi-site";

    // 共通：GitHubのRawデータを取得する関数
    async function fetchFiles(path) {
        const response = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`);
        if (!response.ok) return []; // 404等の場合は空配列を返す
        return await response.json();
    }

    // 1. ライブ情報の取得
    fetchFiles('_data/lives')
        .then(files => {
            const list = document.getElementById('live-list');
            if (!Array.isArray(files) || files.length === 0) {
                list.innerHTML = '<p style="text-align:center;">現在予定されているライブはありません。</p>';
                return;
            }
            
            list.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let hasFutureLives = false;

            Promise.all(files.map(file => fetch(file.download_url).then(r => r.text())))
            .then(yamls => {
                yamls.forEach(yaml => {
                    const getValue = (key) => {
                        const reg = new RegExp(`${key}:\\s*"?([^"\\n]+)"?`);
                        const match = yaml.match(reg);
                        return match ? match[1] : "";
                    };

                    const dateStr = getValue("date");
                    if (!dateStr) return;
                    const liveDate = new Date(dateStr);
                    
                    if (liveDate >= today) {
                        hasFutureLives = true;
                        const open = getValue("open_time"), start = getValue("start_time"), 
                              price = getValue("price"), title = getValue("title"), 
                              place = getValue("place"), artists = getValue("artists"), 
                              url = getValue("ticketUrl");

                        list.innerHTML += `
                            <div class="live-item">
                                <div class="live-date">
                                    ${dateStr.replace(/-/g, '.')}
                                    <div style="font-size: 0.75rem; font-weight: normal; margin-top: 5px; color: var(--sub-text);">
                                        ${open ? `OPEN ${open}` : ''}${open && start ? ' / ' : ''}${start ? `START ${start}` : ''}
                                    </div>
                                </div>
                                <div class="live-info">
                                    <span class="live-title">${title}</span>
                                    ${place ? `<span class="live-place">@ ${place}</span>` : ''}
                                    ${artists ? `<div style="font-size: 0.85rem; color: var(--sub-text); margin-top: 3px;">w / ${artists}</div>` : ''}
                                    ${price ? `<div style="font-size: 0.8rem; color: var(--sub-text); margin-top: 5px;"><i class="fa-solid fa-ticket" style="font-size:0.7rem; margin-right:3px;"></i>${price}</div>` : ''}
                                </div>
                                <div class="live-actions">
                                    ${url ? `<a href="${url}" target="_blank" class="btn">TICKET</a>` : ''}
                                </div>
                            </div>`;
                    }
                });

                if (!hasFutureLives) {
                    list.innerHTML = '<p style="text-align:center;">現在予定されているライブはありません。</p>';
                }

                list.innerHTML += `
                    <div style="text-align: center; margin-top: 40px;">
                        <a href="archive.html" class="btn">PAID LIVE ARCHIVE >></a>
                    </div>
                `;
            });
        }).catch(() => { 
            document.getElementById('live-list').innerHTML = '<p style="text-align:center;">現在予定されているライブはありません。</p>'; 
        });

    // 2. 作品情報の取得
    fetchFiles('_data/discography')
        .then(files => {
            const list = document.getElementById('disc-list');
            if (!Array.isArray(files)) return;

            files.forEach(file => {
                fetch(file.download_url).then(r => r.text()).then(yaml => {
                    const title = yaml.match(/title: "(.+)"/)?.[1] || "";
                    const img = yaml.match(/image: "(.+)"/)?.[1] || "";
                    const yt = yaml.match(/youtube: "(.+)"/)?.[1] || "";
                    const apple = yaml.match(/appleMusic: "(.+)"/)?.[1] || "";
                    const spotify = yaml.match(/spotify: "(.+)"/)?.[1] || "";
                    list.innerHTML += `
                        <div class="disc-item">
                            <img src="${img}" alt="${title}">
                            <h3>${title}</h3>
                            <div class="social-links">
                                ${yt ? `<a href="${yt}" target="_blank"><i class="fab fa-youtube"></i></a>` : ''}
                                ${apple ? `<a href="${apple}" target="_blank"><i class="fab fa-apple"></i></a>` : ''}
                                ${spotify ? `<a href="${spotify}" target="_blank"><i class="fab fa-spotify"></i></a>` : ''}
                            </div>
                        </div>`;
                });
            });
        });

    // パララックス効果
    window.addEventListener('scroll', () => {
        const bg = document.getElementById('hero-bg');
        if(bg) bg.style.transform = `translateY(${window.pageYOffset * 0.4}px) scale(1.05)`;
    });
</script>
